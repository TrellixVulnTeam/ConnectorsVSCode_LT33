import json
from os import environ, setsid
from paconn.common.util import display

from paconn.operations.json_keys import (
    _PROPERTIES,
    _CONNECTION_PARAMETERS)


def create_connection(powerapps_rp, settings, uuid):
    # Just need to creeate connection guid
    # and the payload with the connection parameters
    with open(settings.api_properties, 'r') as file:
        property_definition = json.load(file)

    properties = property_definition[_PROPERTIES]
    connection_parameters = properties.get(_CONNECTION_PARAMETERS, {})
    connector_id = settings.connector_id
    environment = settings.environment

    display(environment)

    connection_id = f'/providers/Microsoft.PowerApps/apis/{connector_id}/connections/{uuid}'
    payload = {
        'properties': {
            'connectionParameters': connection_parameters,
            'environment': {
                'name': environment
            }
        }
    }

    response = powerapps_rp.create_connection(environment, connection_id, payload)
    return response